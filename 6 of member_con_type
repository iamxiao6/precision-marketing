USE 0001476848_pos;

#根据商家业态，快餐形式（先买单后用餐）： "order_property=1" 替换为 "order_property=3"   

##会员结构
#按就餐次数和就餐消费金额区分用户
SELECT SUM(need_pay_amount)/COUNT(0) INTO @avg1 FROM pos_consumption WHERE status_code=1 AND member_id !=0;

SELECT SUM(porder_date_calc.datedif)/SUM(porder_date_calc.con_cou) *1.5 INTO @avg_pay FROM (
SELECT DATEDIFF(MAX(porder.bill_date), MIN(porder.bill_date)) AS datedif,COUNT(0)-1 AS con_cou
FROM pos_dining_order AS porder
INNER JOIN `rv_ol_fans` AS fan ON fan.`member_id` = porder.member_id
WHERE  porder.`status_code`=1 AND porder.member_id<>0 AND porder.member_id<>1 
GROUP BY porder.member_id
HAVING COUNT(0)>1
)
AS porder_date_calc;



SELECT 
member_count.member_id,
member_count.open_id,
member_count.sum_all AS sum_all,
member_days.member_con_type,
0 AS bill_date



FROM (
SELECT fan.member_id, bind.open_id,abc.sum_all FROM (
SELECT member_id, COUNT(0) AS sum_all FROM   `pos_consumption` AS conn
WHERE conn.`status_code`=1 AND member_id<>0  AND conn.order_property=1
GROUP BY conn.member_id
HAVING COUNT(0)>=2 ORDER BY COUNT(0) DESC) AS abc
INNER JOIN `rv_ol_fans` AS fan  ON fan.`member_id`= abc.member_id
INNER JOIN `0001476848_baseinfo`.`ol_fans_sns_bind` AS bind USE INDEX (idx_fans_id) ON fan.fans_id=bind.fans_id AND bind.sns_type=1 AND is_subscribed=1
) AS member_count 

LEFT JOIN `0001476848_member`.`mem_card` AS mcard ON mcard.member_id = member_count.member_id 

#用户细分
LEFT JOIN (
SELECT porder.member_id, COUNT(0) AS sum_all,
         

          CASE WHEN COUNT(0)>2 AND DATEDIFF(NOW(), MAX(porder.bill_date))<= DATEDIFF(MAX(porder.bill_date), MIN(porder.bill_date))/ (COUNT(0) - 1)*1.5
            THEN '忠诚用户1'
            WHEN COUNT(0)=2 AND DATEDIFF(NOW(), MAX(porder.bill_date))<= @avg_pay
            THEN '忠诚用户2'
            WHEN COUNT(0)>2 AND DATEDIFF(NOW(), MAX(porder.bill_date))> DATEDIFF(MAX(porder.bill_date), MIN(porder.bill_date))/ (COUNT(0) - 1)*1.5
            THEN '沉睡用户1'
            WHEN COUNT(0)=2 AND DATEDIFF(NOW(), MAX(porder.bill_date))> @avg_pay
            THEN '沉睡用户2'
            ELSE '' 
          END
          AS 'member_con_type',0 AS bill_date
  FROM pos_consumption AS porder
       INNER JOIN `rv_ol_fans` AS fan ON fan.`member_id` = porder.member_id
       INNER JOIN `0001476848_baseinfo`.`ol_fans_sns_bind` AS bind USE INDEX (idx_fans_id) ON fan.fans_id=bind.fans_id   AND bind.sns_type=1 AND is_subscribed=1
 WHERE porder.`status_code` = 1 AND porder.member_id <> 0
 AND porder.order_property=1
GROUP BY porder.member_id
HAVING COUNT(0) > 1
) AS member_days ON member_days.member_id=member_count.member_id




UNION ALL
#普通会员   消费次数=1次，消费间隔<=平均沉睡周期

SELECT conn.member_id ,  bind.open_id,COUNT(0) AS sum_all,'普通用户' AS member_con_type,conn.bill_date
FROM   `pos_consumption` AS conn
INNER JOIN `rv_ol_fans` AS fan  ON fan.`member_id`= conn.member_id
INNER JOIN `0001476848_baseinfo`.`ol_fans_sns_bind` AS bind USE INDEX (idx_fans_id)  ON fan.fans_id=bind.fans_id   AND bind.sns_type=1 AND is_subscribed=1
LEFT JOIN `0001476848_member`.`mem_card` AS mcard ON mcard.member_id = fan.member_id 
WHERE conn.`status_code`=1 AND conn.member_id<>0 
 AND conn.order_property=1
GROUP BY conn.member_id
HAVING COUNT(0)=1 AND DATEDIFF(NOW(),conn.bill_date)<=@avg_pay

UNION ALL

#流失会员   消费次数=1次，消费间隔>平均沉睡周期
SELECT conn.member_id,  bind.open_id, COUNT(0) AS sum_all,'流失用户'AS member_con_type  ,conn.bill_date
FROM   `pos_consumption` AS conn
INNER JOIN `rv_ol_fans` AS fan  ON fan.`member_id`= conn.member_id
INNER JOIN `0001476848_baseinfo`.`ol_fans_sns_bind` AS bind USE INDEX (idx_fans_id) ON fan.fans_id=bind.fans_id   AND bind.sns_type=1 AND is_subscribed=1
LEFT JOIN `0001476848_member`.`mem_card` AS mcard ON mcard.member_id = fan.member_id 
WHERE conn.`status_code`=1 AND conn.member_id<>0 
AND conn.order_property=1
GROUP BY conn.member_id
HAVING COUNT(0)=1   AND DATEDIFF(NOW(),conn.bill_date)>@avg_pay 

UNION ALL

#陪同用户，没有消费记录
SELECT  
 fan.member_id, bind.open_id,  0 AS sum_all ,'陪同用户' AS member_con_type ,0 AS bill_date
FROM    `rv_ol_fans` AS fan 
INNER JOIN `0001476848_baseinfo`.`ol_fans_sns_bind` AS bind USE INDEX (idx_fans_id) ON fan.fans_id=bind.fans_id   AND bind.sns_type=1 AND is_subscribed=1
LEFT JOIN pos_consumption AS conn ON conn.member_id=fan.member_id
LEFT JOIN `0001476848_member`.`mem_card` AS mcard ON mcard.member_id = fan.member_id 
WHERE  fan.member_id<>0 AND  conn.member_id IS NULL AND fan.source_type IN(1,3,4,6,14,18,19)  # 来源类型（1-自行关注，2-通过砍价活动关注，3-通过扫描POS台单关注）

UNION ALL
#潜在用户，消费次数为0,非店内关注
SELECT  
 fan.member_id, bind.open_id,  0 AS sum_all ,'潜在用户' AS member_con_type ,0 AS bill_date
FROM    `rv_ol_fans` AS fan 
INNER JOIN `0001476848_baseinfo`.`ol_fans_sns_bind` AS bind USE INDEX (idx_fans_id) ON fan.fans_id=bind.fans_id   AND bind.sns_type=1 AND is_subscribed=1
LEFT JOIN pos_consumption AS conn ON conn.member_id=fan.member_id
LEFT JOIN `0001476848_member`.`mem_card` AS mcard ON mcard.member_id = fan.member_id 
WHERE  fan.member_id<>0 AND  conn.member_id IS NULL AND fan.source_type NOT IN(1,3,4,6,14,18,19)


UNION ALL
#潜在用户，消费次数为0,非店内关注
SELECT  
 fan.member_id,bind.open_id,  0   AS sum_all ,'无会员ID' AS member_con_type ,0 AS bill_date
FROM    `rv_ol_fans` AS fan 
INNER JOIN `0001476848_baseinfo`.`ol_fans_sns_bind` AS bind USE INDEX (idx_fans_id) ON fan.fans_id=bind.fans_id   AND bind.sns_type=1 AND is_subscribed=1
WHERE  fan.member_id=0 





 
